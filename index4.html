<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Facebook Ads Report Generator</title>

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
  /* CSS Variables for the Light Theme (Updated with new palette) */
  :root {
    --rich-black: #0D1B2A;
    --oxford-blue: #1b263bff;
    --yinmn-blue: #415a77ff;
    --silver-lake-blue: #778da9ff;
    --platinum: #e0e1ddff;

    --background-light: var(--platinum);
    --text-dark: var(--rich-black);
    --text-light: #ffffff;
    --accent-primary: var(--oxford-blue);
    --accent-secondary: var(--yinmn-blue);
    --element-bg-light: #ffffff;
    --table-header-bg: var(--oxford-blue);
    --border-color: rgba(0, 0, 0, 0.1);
    --input-placeholder-color: var(--silver-lake-blue);

    /* New colors for specific elements */
    --report-title-color: var(--oxford-blue);
    --report-subtitle-color: var(--yinmn-blue);
    --button-hover-color: var(--yinmn-blue);
    --danger-color: #ae2012;
    --danger-hover-color: #9b2226;

    /* RGB values for Chart.js and dynamic styling */
    --oxford-blue-rgb: 27, 38, 59;
    --yinmn-blue-rgb: 65, 90, 119;
    --silver-lake-blue-rgb: 119, 141, 169;
    --red-kpi-rgb: 221, 51, 51; /* RGB for #dd3333 */


    /* New palette (kept for other elements if used, but chart will use default) */
    --seal-brown: #582f0eff;
    --russet: #7f4f24ff;
    --raw-umber: #936639ff;
    --lion: #a68a64ff;
    --khaki: #b6ad90ff;
    --sage: #c2c5aaff;
    --sage-2: #a4ac86ff;
    --reseda-green: #656d4aff;
    --ebony: #414833ff;
    --black-olive: #333d29ff;

    /* RGB values for new palette for Chart.js (kept for reference, but chart will use default) */
    --seal-brown-rgb: 88, 47, 14;
    --russet-rgb: 127, 79, 36;
    --raw-umber-rgb: 147, 102, 57;
    --lion-rgb: 166, 138, 100;
    --khaki-rgb: 182, 173, 144;
    --sage-rgb: 194, 197, 170;
    --sage-2-rgb: 164, 172, 134;
    --reseda-green-rgb: 101, 109, 74;
    --ebony-rgb: 65, 72, 51;
    --black-olive-rgb: 51, 61, 41;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background-color: var(--background-light);
    color: var(--text-dark);
    margin: 0;
    padding: 20px;
    line-height: 1.4;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    box-sizing: border-box;
    font-size: 1.05em;
    font-weight: 400;
  }

  h1, h2, h3, p {
    color: var(--text-dark);
    margin-top: 0;
    font-weight: 400;
  }

  #fileUploadContainer, #reportContainer {
    background-color: var(--element-bg-light);
    border-radius: 15px; /* Slightly more rounded */
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12); /* Slightly stronger shadow */
    padding: 30px;
    margin-bottom: 30px;
    width: 100%;
    max-width: 900px;
    box-sizing: border-box;
    border: 1px solid var(--border-color);
  }

  /* Input Group Styling for Client/Campaign/Date */
  .input-group {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
  }

  .text-input-label {
    flex-shrink: 0;
    width: 120px;
    font-size: 1.0em;
    color: var(--text-dark);
    text-align: right;
  }

  .text-input-field {
    flex-grow: 1;
    background-color: #ffffff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 18px;
    font-size: 1.0em;
    color: var(--text-dark);
    transition: all 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    outline: none;
  }

  .text-input-field::placeholder {
    color: var(--input-placeholder-color);
    opacity: 1;
  }

  .text-input-field:focus {
    border-color: var(--accent-primary);
    box-shadow: inset 0 1px 5px rgba(0,0,0,0.2), 0 0 8px rgba(var(--oxford-blue-rgb), 0.2);
  }

  /* Flatpickr overrides for better theme integration */
  .flatpickr-calendar {
    font-family: 'DM Sans', sans-serif;
    border: 1:px solid var(--border-color);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    background-color: var(--element-bg-light);
  }
  .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover {
    background-color: var(--accent-primary) !important;
    border-color: var(--accent-primary) !important;
    color: var(--text-light) !important;
  }
  .flatpickr-day.inRange {
    background-color: rgba(var(--oxford-blue-rgb), 0.1) !important;
    border-color: rgba(var(--oxford-blue-rgb), 0.1) !important;
    color: var(--text-dark);
  }
  .flatpickr-current-month .flatpickr-monthTitle, .flatpickr-current-month .flatpickr-year {
    color: var(--text-dark);
  }
  .flatpickr-weekdays {
    background-color: var(--table-header-bg);
  }
  .flatpickr-weekday {
    color: var(--text-light);
  }
  .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month {
    color: var(--accent-primary);
  }


  /* File Input Specific Styling */
  .file-input-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    margin-top: 25px;
  }

  .file-input-label {
    display: flex;
    flex-grow: 1;
    background-color: #ffffff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 18px;
    cursor: pointer;
    font-size: 1.0em;
    color: var(--input-placeholder-color);
    transition: all 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    align-items: center;
  }

  .file-input-label:hover {
    border-color: var(--accent-primary);
    box-shadow: inset 0 1px 5px rgba(0,0,0,0.2), 0 0 8px rgba(var(--oxford-blue-rgb), 0.2);
  }

  .file-input-label::before {
    content: 'Upload JSON File';
    flex-grow: 1;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-input-label.has-file::before {
      content: attr(data-filename);
      color: var(--text-dark);
  }

  #jsonFileInput {
    display: none;
  }

  #generateReportBtn {
    padding: 12px 25px;
    background-color: var(--accent-primary);
    color: var(--text-light);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.0em;
    font-weight: 500;
    transition: background-color 0.3s ease, transform 0.2s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  #generateReportBtn:disabled {
    background-color: var(--silver-lake-blue);
    cursor: not-allowed;
    opacity: 0.7;
    box-shadow: none;
  }

  #generateReportBtn:not(:disabled):hover {
    background-color: var(--button-hover-color);
    transform: translateY(-2px);
  }

  .error-message {
    color: var(--danger-color);
    text-align: center;
    margin-top: 10px;
    font-weight: 500;
  }

  #reportContainer {
    display: none;
  }

  #reportHeader {
    margin-bottom: 25px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 20px;
    /* Updated for layout without absolute positioning for date */
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    text-align: left;
  }

  #reportHeader-left {
    flex-grow: 1;
    text-align: left;
  }

  #reportHeader-right {
    flex-shrink: 0; /* Prevent it from shrinking */
    text-align: right; /* Align content to the right */
    padding-left: 20px; /* Add some space between left and right */
  }

  #logo {
    max-width: 250px; /* Bigger logo */
    height: auto;
    margin-bottom: 15px;
    display: block;
  }

  #reportHeader h1 {
    color: var(--report-title-color);
    font-size: 2.0em; /* Reduced size */
    margin-bottom: 10px;
    font-weight: 500;
  }

  #reportHeader h2 {
    color: var(--report-subtitle-color);
    font-size: 1.2em;
    margin-bottom: 8px;
    font-weight: 400;
  }

  #reportHeader p {
    font-size: 1.2em;
    margin-bottom: 5px;
    color: var(--report-subtitle-color);
    font-weight: 400;
  }

  .header-value {
    color: var(--report-subtitle-color);
    font-weight: 400;
  }

  #dateIssued {
    font-size: 0.9em;
    color: rgba(0, 0, 0, 0.6);
  }

  /* Section titles */
  .section-title {
    font-size: 1.5em;
    color: var(--oxford-blue);
    margin-bottom: 20px;
    margin-top: 35px;
    border-bottom: 2px solid var(--silver-lake-blue);
    padding-bottom: 8px;
    font-weight: 500;
  }


  .kpiContainer {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
  }

  .kpiBox {
    /* Base styles for KPI box */
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    flex: 1;
    min-width: 200px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
  }

  /* Specific background colors for each KPI box */
  .kpiBox.kpiReach {
    background-color: var(--oxford-blue); /* Solid dark blue */
  }
  .kpiBox.kpiImpressions {
    background-color: #dd3333; /* Explicit red */
  }
  .kpiBox.kpiClicks {
    background-color: var(--yinmn-blue); /* Solid medium blue-grey */
  }

  .kpiBox h3 {
    font-size: 2.5em;
    color: var(--text-light); /* White font for KPI values */
    margin-bottom: 5px;
    font-weight: 500;
  }

  .kpiBox p {
    font-size: 1.0em;
    color: var(--text-light); /* White font for KPI labels */
    font-weight: 400;
  }

  .summary {
    background-color: var(--element-bg-light);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
    font-size: 1.0em;
    color: var(--text-dark);
    text-align: justify;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .summary span {
    font-weight: 400;
    color: var(--report-subtitle-color);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    font-size: 0.9em;
    background-color: var(--element-bg-light);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  table thead th {
    background-color: var(--table-header-bg);
    color: var(--text-light);
    padding: 15px;
    text-align: left;
    font-weight: 400;
    border-bottom: 1px solid var(--border-color);
  }

  table tbody td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-dark);
  }

  table tbody tr:last-child td {
    border-bottom: none;
  }

  table tbody tr:nth-child(even) {
    background-color: rgba(0, 0, 0, 0.03);
  }

  .total-row {
    font-weight: 400;
    background-color: var(--silver-lake-blue);
    color: var(--rich-black); /* Using rich-black for total row text */
  }

  /* Heatmap styling for table cells - applied dynamically by JS */
  .heatmap-cell {
    transition: background-color 0.5s ease;
  }

  #chartContainer {
    background-color: var(--element-bg-light);
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
    position: relative;
    height: 400px;
  }

  #reportChart {
    width: 100% !important;
    height: 100% !important;
  }

  #downloadPdfBtn {
    display: block;
    width: fit-content;
    margin: 0 auto;
    padding: 15px 30px;
    background-color: var(--danger-color);
    color: var(--text-light);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.0em;
    font-weight: 500;
    transition: background-color 0.3s ease, transform 0.2s ease;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }

  #downloadPdfBtn:disabled {
    background-color: var(--silver-lake-blue);
    cursor: not-allowed;
    opacity: 0.7;
    box-shadow: none;
  }

  #downloadPdfBtn:not(:disabled):hover {
    background-color: var(--danger-hover-color);
    transform: translateY(-2px);
  }

  .report-footer {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
    color: rgba(0, 0, 0, 0.6);
    font-size: 0.85em;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .input-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    .text-input-label {
        text-align: left;
        width: auto;
    }
    #reportHeader {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    #reportHeader-left {
        text-align: center;
        width: 100%;
        margin-bottom: 20px;
    }
    #reportHeader-right {
        padding-left: 0; /* Remove padding for smaller screens */
        text-align: center; /* Center align for smaller screens */
        width: 100%; /* Take full width */
    }
    .kpiContainer {
      flex-direction: column;
      align-items: center;
    }
    .kpiBox {
      width: 80%;
      min-width: unset;
    }
    table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    #chartContainer {
      height: 300px;
    }
  }
</style>
</head>
<body>

<div id="fileUploadContainer">
  <div class="input-group">
    <label for="clientInput" class="text-input-label">Client Name:</label>
    <input type="text" id="clientInput" class="text-input-field" placeholder="e.g., Lottotech" value="Lotto"/>
  </div>
  <div class="input-group">
    <label for="campaignInput" class="text-input-label">Campaign Name:</label>
    <input type="text" id="campaignInput" class="text-input-field" placeholder="e.g., Video 1" value="cceee"/>
  </div>
  <div class="input-group">
    <label for="runningDateInput" class="text-input-label">Reporting Period:</label>
    <input type="text" id="runningDateInput" class="text-input-field" placeholder="e.g., 2025-05-01 to 2025-05-31" value="2025-07-10 to 2025-07-15"/>
  </div>

  <div class="file-input-wrapper">
    <label for="jsonFileInput" class="file-input-label" id="fileInputLabel">
      </label>
    <input type="file" id="jsonFileInput" accept=".json" />
    <button id="generateReportBtn" disabled>Generate Report</button>
  </div>
  <div id="fileError" class="error-message"></div>
</div>

<div id="reportContainer" style="display: none;">
  <div id="reportHeader">
    <div id="reportHeader-left">
        <img id="logo" src="Le_Mauricien_com@HD.png" alt="Le Mauricien Logo" />
        <h1>Facebook Ads Report</h1>
        <h2>Client: <span id="displayClientName" class="header-value"></span></h2>
        <p><strong>Campaign:</strong> <span id="displayCampaignName" class="header-value"></span></p>
        <p><strong>Reporting Period:</strong> <span id="displayReportingPeriod" class="header-value"></span></p>
    </div>
    <div id="reportHeader-right">
        <div id="dateIssued">Date of Issue: <span id="currentDate"></span></div>
    </div>
  </div>

  <h2 class="section-title">Key Performance Indicators</h2>
  <div class="kpiContainer">
    <div class="kpiBox kpiReach">
      <h3 id="totalReach">0</h3>
      <p>Accounts Reach</p>
    </div>
    <div class="kpiBox kpiImpressions">
      <h3 id="totalImpressions">0</h3>
      <p>Impressions</p>
    </div>
    <div class="kpiBox kpiClicks">
      <h3 id="totalClicks">0</h3>
      <p>Clicks</p>
    </div>
  </div>

  <p class="summary">
    Over the campaign period, the Facebook ads reached a total of <span class="summary-reach">0</span> unique accounts with
    <span class="summary-impressions">0</span> impressions generating <span class="summary-clicks">0</span> clicks. This demonstrates strong audience engagement and effective ad delivery.
  </p>

  <h2 class="section-title">Daily Performance Breakdown</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Impressions</th>
        <th>Reach</th>
        <th>CTR (all) %</th>
        <th>Clicks</th>
        <th>Page Engagement</th>
      </tr>
    </thead>
    <tbody id="reportTableBody">
      </tbody>
  </table>

  <h2 class="section-title">Daily Trend Analysis</h2>
  <div id="chartContainer">
    <canvas id="reportChart" height="180"></canvas>
  </div>

  <h2 class="section-title">Audience Demographics Breakdown (Age & Gender)</h2>
  <table id="genderAgeTable">
    <thead>
      <tr>
        <th>Gender</th>
        <th>Age Group</th>
        <th>Total Impressions</th>
        <th>Total Reach</th>
        <th>Total Clicks</th>
      </tr>
    </thead>
    <tbody id="genderAgeTableBody">
      </tbody>
  </table>

  <button id="downloadPdfBtn">Download Report as PDF</button>

  <div class="report-footer">
      &copy; <span id="copyrightYear"></span> <span id="footerClientName"></span>. All rights reserved.
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const jsonFileInput = document.getElementById('jsonFileInput');
  const fileInputLabel = document.getElementById('fileInputLabel');
  const generateReportBtn = document.getElementById('generateReportBtn');
  const fileError = document.getElementById('fileError');
  const reportContainer = document.getElementById('reportContainer');
  const reportTableBody = document.getElementById('reportTableBody');
  const totalReachElem = document.getElementById('totalReach');
  const totalImpressionsElem = document.getElementById('totalImpressions');
  const totalClicksElem = document.getElementById('totalClicks');
  const summaryReachElem = document.querySelector('.summary-reach');
  const summaryImpressionsElem = document.querySelector('.summary-impressions');
  const summaryClicksElem = document.querySelector('.summary-clicks');
  const currentDateElem = document.getElementById('currentDate');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');
  const genderAgeTableBody = document.getElementById('genderAgeTableBody'); // New table body element

  // Input elements for Client, Campaign, Running Date
  const clientInput = document.getElementById('clientInput');
  const campaignInput = document.getElementById('campaignInput');
  const runningDateInput = document.getElementById('runningDateInput');

  // Display elements in the report header
  const displayClientName = document.getElementById('displayClientName');
  const displayCampaignName = document.getElementById('displayCampaignName');
  const displayReportingPeriod = document.getElementById('displayReportingPeriod');

  // Footer elements
  const copyrightYearElem = document.getElementById('copyrightYear');
  const footerClientNameElem = document.getElementById('footerClientName');

  let reportChart;

  // Initialize Flatpickr for the date input
  flatpickr("#runningDateInput", {
    dateFormat: "Y-m-d",
    mode: "range"
  });

  // Function to check if inputs are valid for enabling the button
  function checkInputs() {
    const isFileSelected = jsonFileInput.files.length > 0;
    const isClientNameFilled = clientInput.value.trim() !== '';
    const isCampaignNameFilled = campaignInput.value.trim() !== '';
    generateReportBtn.disabled = !(isFileSelected && isClientNameFilled && isCampaignNameFilled);
  }

  // Set current date
  currentDateElem.textContent = new Date().toISOString().slice(0, 10);
  copyrightYearElem.textContent = new Date().getFullYear();

  // Event listeners for text inputs to enable/disable button
  clientInput.addEventListener('input', () => {
    checkInputs();
    footerClientNameElem.textContent = clientInput.value.trim();
  });
  campaignInput.addEventListener('input', checkInputs);
  runningDateInput.addEventListener('input', checkInputs);

  // Handle file input changes for the custom label and button state
  jsonFileInput.addEventListener('change', () => {
    if (jsonFileInput.files.length > 0) {
      const fileName = jsonFileInput.files[0].name;
      fileInputLabel.textContent = fileName;
      fileInputLabel.setAttribute('data-filename', fileName);
      fileInputLabel.classList.add('has-file');
      fileError.textContent = '';
    } else {
      fileInputLabel.textContent = '';
      fileInputLabel.removeAttribute('data-filename');
      fileInputLabel.classList.remove('has-file');
    }
    checkInputs();
  });


  generateReportBtn.addEventListener('click', async () => {
    const file = jsonFileInput.files[0];
    if (!file) {
      fileError.textContent = 'Please select a JSON file to upload.';
      return;
    }

    try {
      const mainAdsData = await parseJSONFile(file);
      const genderAgeData = await fetchGenderAgeData();

      if (mainAdsData && genderAgeData) {
        renderReport(mainAdsData);
        renderGenderAgeTable(genderAgeData);
        reportContainer.style.display = 'block';
        fileError.textContent = '';
      } else {
        fileError.textContent = 'Failed to load all required data files.';
        reportContainer.style.display = 'none';
      }
    } catch (e) {
      fileError.textContent = 'Error generating report: ' + e.message;
      reportContainer.style.display = 'none';
    }
  });

  downloadPdfBtn.addEventListener('click', generatePdf);

  function parseJSONFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = JSON.parse(event.target.result);
          if (!Array.isArray(data) || data.length === 0) {
            reject(new Error('JSON file is empty or does not contain a valid array of data.'));
            return;
          }
          const requiredHeaders = ["Reporting starts", "Reporting ends", "Impressions", "Reach", "Clicks (all)", "CTR (all)", "Page engagement"];
          const actualHeaders = Object.keys(data[0]);
          const missingHeaders = requiredHeaders.filter(header => !actualHeaders.includes(header));

          if (missingHeaders.length > 0) {
            reject(new Error(`Missing required JSON keys: ${missingHeaders.join(', ')}. Please ensure your JSON has these exact keys.`));
            return;
          }
          resolve(data);
        } catch (e) {
          reject(new Error('Error parsing JSON file: ' + e.message));
        }
      };
      reader.onerror = function(event) {
        reject(new Error('Failed to read JSON file: ' + event.target.error));
      };
      reader.readAsText(file);
    });
  }

  async function fetchGenderAgeData() {
    try {
      const response = await fetch('gender_age_data.json'); // Assuming this file is in the same directory
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.json();
    } catch (e) {
      console.error('Error fetching gender_age_data.json:', e);
      fileError.textContent = 'Could not load gender and age data. Make sure "gender_age_data.json" is in the same directory.';
      return null;
    }
  }


  function getMinMaxValues(data, columns) {
      const minMax = {};
      columns.forEach(col => {
          let values = data.map(row => parseFloat(row[col]) || 0);
          values = values.filter(val => !isNaN(val));
          minMax[col] = {
              min: values.length > 0 ? Math.min(...values) : 0,
              max: values.length > 0 ? Math.max(...values) : 0
          };
      });
      return minMax;
  }

  function renderReport(data) {
    reportTableBody.innerHTML = '';

    // Sort data by 'Reporting starts' date
    data.sort((a, b) => {
        const dateA = new Date(a['Reporting starts']);
        const dateB = new Date(b['Reporting starts']);
        return dateA - dateB;
    });

    let totalImpressions = 0;
    let totalReach = 0;
    let totalClicks = 0;
    let totalPageEngagement = 0;

    const dates = [];
    // Changed to store daily values instead of cumulative
    const dailyImpressionsData = [];
    const dailyReachData = [];
    const dailyClicksData = [];

    const numericColumnsForHeatmap = ["Impressions", "Reach", "Clicks (all)", "Page engagement"];
    const minMaxValues = getMinMaxValues(data, numericColumnsForHeatmap);

    // Populate table and collect chart data
    data.forEach(row => {
      const startDate = row['Reporting starts'];
      const impressions = parseInt(row['Impressions']) || 0;
      const reach = parseInt(row['Reach']) || 0;
      const clicks = parseInt(row['Clicks (all)']) || 0;
      const ctr = parseFloat(row['CTR (all)']) || 0;
      const pageEngagement = parseInt(row['Page engagement']) || 0;

      totalImpressions += impressions;
      totalReach += reach;
      totalClicks += clicks;
      totalPageEngagement += pageEngagement;

      dates.push(startDate);
      // Store daily values
      dailyImpressionsData.push(impressions);
      dailyReachData.push(reach);
      dailyClicksData.push(clicks);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="data-cell">${startDate}</td>
        <td class="data-cell impressions-cell">${impressions.toLocaleString()}</td>
        <td class="data-cell reach-cell">${reach.toLocaleString()}</td>
        <td class="data-cell">${ctr.toFixed(2)}</td>
        <td class="data-cell clicks-cell">${clicks.toLocaleString()}</td>
        <td class="data-cell page-engagement-cell">${pageEngagement.toLocaleString()}</td>
      `;
      reportTableBody.appendChild(tr);
    });

    // Apply heatmap styling
    applyHeatmap(reportTableBody, data, minMaxValues);

    // Add total row
    const totalRow = document.createElement('tr');
    totalRow.classList.add('total-row');
    totalRow.innerHTML = `
      <td>Total</td>
      <td>${totalImpressions.toLocaleString()}</td>
      <td>${totalReach.toLocaleString()}</td>
      <td>-</td>
      <td>${totalClicks.toLocaleString()}</td>
      <td>${totalPageEngagement.toLocaleString()}</td>
    `;
    reportTableBody.appendChild(totalRow);

    // Update KPIs
    totalReachElem.textContent = totalReach.toLocaleString();
    totalImpressionsElem.textContent = totalImpressions.toLocaleString();
    totalClicksElem.textContent = totalClicks.toLocaleString();

    // Update summary paragraph
    summaryReachElem.textContent = totalReach.toLocaleString();
    summaryImpressionsElem.textContent = totalImpressions.toLocaleString();
    summaryClicksElem.textContent = totalClicks.toLocaleString();

    // Set values from input fields to report header
    displayClientName.textContent = clientInput.value.trim() || 'N/A';
    displayCampaignName.textContent = campaignInput.value.trim() || 'N/A';
    displayReportingPeriod.textContent = runningDateInput.value.trim() || `${dates[0] || 'N/A'} to ${dates[dates.length - 1] || 'N/A'}`;
    footerClientNameElem.textContent = clientInput.value.trim() || 'Your Company';


    // Render Chart with daily data
    renderChart(dates, dailyReachData, dailyImpressionsData); // Removed dailyClicksData from chart
  }

  function applyHeatmap(tableBody, data, minMaxValues) {
      const rows = tableBody.querySelectorAll('tr');
      const numericColumnIndices = {
          'impressions-cell': 'Impressions',
          'reach-cell': 'Reach',
          'clicks-cell': 'Clicks (all)',
          'page-engagement-cell': 'Page engagement'
      };

      rows.forEach((row, rowIndex) => {
          if (row.classList.contains('total-row')) return;

          const cells = row.querySelectorAll('.data-cell');
          cells.forEach(cell => {
              for (const className in numericColumnIndices) {
                  if (cell.classList.contains(className)) {
                      const columnName = numericColumnIndices[className];
                      const value = parseFloat(data[rowIndex][columnName]) || 0;
                      const min = minMaxValues[columnName].min;
                      const max = minMaxValues[columnName].max;

                      if (max > min) {
                          // Blend between silver-lake-blue and yinmn-blue for heatmap
                          const r1 = 119, g1 = 141, b1 = 169; // silver-lake-blue (approx RGB)
                          const r2 = 65, g2 = 90, b2 = 119;   // yinmn-blue (approx RGB)

                          const ratio = (value - min) / (max - min);
                          const r = Math.round(r1 + (r2 - r1) * ratio);
                          const g = Math.round(g1 + (g2 - g1) * ratio);
                          const b = Math.round(b1 + (b2 - b1) * ratio);

                          cell.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.5)`; /* Increased opacity for more contrast */
                      } else {
                          cell.style.backgroundColor = `rgba(119, 141, 169, 0.2)`; /* Increased opacity for base if all values are same */
                      }
                      break;
                  }
              }
          });
      });
  }


  function renderChart(dates, dailyReachData, dailyImpressionsData) { // Removed dailyClicksData parameter
    if (reportChart) {
      reportChart.destroy();
    }

    // Get CSS variable values for chart colors
    const style = getComputedStyle(document.documentElement);
    const richBlack = style.getPropertyValue('--rich-black');

    const ctx = document.getElementById('reportChart').getContext('2d');

    reportChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'Daily Reach',
            data: dailyReachData,
            // Using Chart.js original colors
            borderWidth: 2,
            datalabels: {
              display: true,
              color: richBlack,
              anchor: 'end',
              align: 'top',
              font: { weight: '400', size: 12 },
              formatter: function(value) {
                return value.toLocaleString();
              }
            }
          },
          {
            label: 'Daily Impressions',
            data: dailyImpressionsData,
            // Using Chart.js original colors
            borderWidth: 2,
            datalabels: {
              display: true,
              color: richBlack,
              anchor: 'end',
              align: 'top',
              font: { weight: '400', size: 12 },
              formatter: function(value) {
                return value.toLocaleString();
              }
            }
          }
          // Removed 'Daily Clicks' dataset as requested
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: {
              color: richBlack,
              callback: function(value) {
                  return value.toLocaleString();
              }
            }
          },
          x: {
            grid: { display: false },
            ticks: {
              color: richBlack
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              font: { weight: '500', size: 14 },
              color: richBlack
            }
          },
          datalabels: {
            display: true
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'var(--element-bg-light)',
            titleColor: richBlack,
            bodyColor: richBlack,
            borderColor: 'var(--border-color)',
            borderWidth: 1
          },
          title: { /* Added Chart Title */
            display: true,
            text: 'Daily Reach and Impressions', /* Updated title */
            color: richBlack,
            font: {
              size: 16,
              weight: '500'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  // New function to render Gender and Age table
  function renderGenderAgeTable(data) {
    genderAgeTableBody.innerHTML = ''; // Clear existing content

    // Define the order of age groups for sorting
    const ageOrder = ['13-17', '18-24', '25-34', '35-44', '45-54', '55-64', '65+'];

    // Sort data by Gender (female, male, unknown) and then by Age Group
    data.sort((a, b) => {
        const genderOrder = ['female', 'male', 'unknown'];
        const genderCompare = genderOrder.indexOf(a.Gender) - genderOrder.indexOf(b.Gender);
        if (genderCompare !== 0) return genderCompare;

        return ageOrder.indexOf(a.Age) - ageOrder.indexOf(b.Age);
    });

    let totalAgeGenderImpressions = 0;
    let totalAgeGenderReach = 0;
    let totalAgeGenderClicks = 0;

    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.Gender}</td>
        <td>${row.Age}</td>
        <td>${row.Total_Impressions.toLocaleString()}</td>
        <td>${row.Total_Reach.toLocaleString()}</td>
        <td>${row.Total_Clicks.toLocaleString()}</td>
      `;
      genderAgeTableBody.appendChild(tr);

      totalAgeGenderImpressions += row.Total_Impressions;
      totalAgeGenderReach += row.Total_Reach;
      totalAgeGenderClicks += row.Total_Clicks;
    });

    // Add a total row for Gender/Age table
    const totalRow = document.createElement('tr');
    totalRow.classList.add('total-row');
    totalRow.innerHTML = `
      <td colspan="2">Total</td>
      <td>${totalAgeGenderImpressions.toLocaleString()}</td>
      <td>${totalAgeGenderReach.toLocaleString()}</td>
      <td>${totalAgeGenderClicks.toLocaleString()}</td>
    `;
    genderAgeTableBody.appendChild(totalRow);
  }

  async function generatePdf() {
    downloadPdfBtn.textContent = 'Generating PDF...';
    downloadPdfBtn.disabled = true;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');

    const reportElement = document.getElementById('reportContainer');

    const originalBodyBg = document.body.style.backgroundColor;
    document.body.style.backgroundColor = 'white';

    await html2canvas(reportElement, {
      scale: 2,
      useCORS: true,
      windowWidth: reportElement.scrollWidth,
      windowHeight: reportElement.scrollHeight,
      backgroundColor: getComputedStyle(reportElement).backgroundColor
    }).then(canvas => {
      document.body.style.backgroundColor = originalBodyBg;

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 595.28;
      const pageHeight = 841.89;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;

      doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        position = heightLeft - imgHeight;
        doc.addPage();
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      doc.save('facebook_ads_report.pdf');

      downloadPdfBtn.textContent = 'Download Report as PDF';
      downloadPdfBtn.disabled = false;
    });
  }

  // Initial check on load
  checkInputs();
  footerClientNameElem.textContent = clientInput.value.trim() || 'Your Company'; // Set initial footer client name
});
</script>

</body>
</html>